services:
  openwrt-sdk:
    build:
      context: .
      dockerfile: Dockerfile
    image: mini-mwan-builder
    container_name: mini-mwan-builder
    volumes:
      # Mount local OpenWRT repositories from host (create ~/openwrt-repos first)
      - ~/openwrt-repos:/openwrt-repos:rw
      #and inside those repositories there will be our packages to be built
      - ./mini-mwan:/openwrt-repos/packages/net/mini-mwan/:ro
      - ./luci-app-mini-mwan:/openwrt-repos/luci/applications/luci-app-mini-mwan/:ro
      # Mount custom feeds configuration
      - ./feeds.conf:/builder/feeds.conf:ro
      # NOTE: there is no way to preserve .config between builds. Therefore, configuration will always remain
      # ephemeral, at least until the moment when I figure out how to work it around.
      # Mount output directory for built packages
      - ./bin:/builder/bin
      # Use named volumes for build artifacts (faster than macOS filesystem)
      - openwrt-feeds:/builder/feeds
      - openwrt-dl:/builder/dl
    working_dir: /builder
    stdin_open: true
    tty: true

volumes:
  openwrt-feeds:
  openwrt-dl:
